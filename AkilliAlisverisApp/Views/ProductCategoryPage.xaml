<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:AkilliAlisverisApp.ViewModels"
    xmlns:models="clr-namespace:AkilliAlisverisApp.Models"
    xmlns:mct="clr-namespace:CommunityToolkit.Maui.Behaviors;assembly=CommunityToolkit.Maui"
    x:Class="AkilliAlisverisApp.Views.ProductCategoryPage"
    Title="{Binding Title}"
    x:DataType="viewmodels:ProductCategoryViewModel">

    <ContentPage.Behaviors>
        <!-- OnAppearing yerine LoadProductsCommand yalnızca ilk açılışta çalışacak -->
        <mct:EventToCommandBehavior EventName="Appearing" Command="{Binding LoadProductsCommand}" />
    </ContentPage.Behaviors>

    <VerticalStackLayout Padding="10">
        <SearchBar x:Name="searchBar" Placeholder="Bu kategoride ürün ara...">
            <SearchBar.Behaviors>
                <mct:EventToCommandBehavior 
                    EventName="TextChanged"
                    Command="{Binding TextChangedCommand}"
                    CommandParameter="{Binding Text, Source={x:Reference searchBar}}" />
            </SearchBar.Behaviors>
        </SearchBar>

        <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" />

        <CollectionView ItemsSource="{Binding Products}" SelectionMode="None">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Product">
                    <Frame Margin="5" Padding="10" BorderColor="LightGray" CornerRadius="10">
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer 
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ProductCategoryViewModel}}, Path=NavigateToProductDetailCommand}"
                                CommandParameter="{Binding .}" />
                        </Frame.GestureRecognizers>
                        <VerticalStackLayout>
                            <Image Source="{Binding ImageUrl}" Aspect="AspectFill" HeightRequest="150" WidthRequest="200" HorizontalOptions="Center" />
                            <Label Text="{Binding ProductName}" FontSize="18" FontAttributes="Bold" TextColor="Black" Margin="0,5,0,0" />
                            <Label Text="{Binding Price, StringFormat='₺ {0:F2}'}" FontSize="16" TextColor="Green" />
                            <Label Text="{Binding MarketName}" FontSize="14" TextColor="DarkGray" />
                            <Label Text="{Binding Description}" FontSize="14" TextColor="Gray" LineBreakMode="TailTruncation" MaxLines="3" Margin="0,5,0,0" />
                            <Label Text="{Binding DiscountStartDate, StringFormat='Başlangıç: {0:dd.MM.yyyy}'}" FontSize="12" TextColor="Blue" />
                            <Label Text="{Binding DiscountEndDate, StringFormat='Bitiş: {0:dd.MM.yyyy}'}" FontSize="12" TextColor="Red" />
                        </VerticalStackLayout>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </VerticalStackLayout>
</ContentPage>
